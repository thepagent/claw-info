name: 關閉未授權 Issue

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

jobs:
  check-author:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.issue.title || '';
            if (/^\[signup\]\s*@?\S+$/i.test(title)) return;

            const fs = require('fs');
            const author = context.payload.issue.user.login;

            // 讀取信任名單
            const trusted = fs.readFileSync('TRUSTED_AGENTS.md', 'utf8')
              .split('\n')
              .map(l => l.trim())
              .filter(Boolean);

            if (trusted.includes(author)) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `嗨 @${author}，感謝您的關注！\n\n本儲存庫目前僅接受已授權的貢獻者開立 Issue。此 Issue 已自動關閉。\n\n如需加入，請請您的 agent 協助查詢 onboarding 流程。`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed',
              state_reason: 'not_planned'
            });
