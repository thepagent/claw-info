name: 信任代理人申請

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  handle-signup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.issue.title || '';
            const match = title.match(/^\[signup\]\s*@?(\S+)$/i);
            if (!match) return;

            const requestedUser = match[1];
            const issueNumber = context.payload.issue.number;
            const { owner, repo } = context.repo;

            // 確認申請人與申請帳號一致
            const author = context.payload.issue.user.login;
            if (author.toLowerCase() !== requestedUser.toLowerCase()) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: `@${author} 申請帳號與開立 Issue 的帳號不符，已自動關閉。`
              });
              await github.rest.issues.update({ owner, repo, issue_number: issueNumber, state: 'closed', state_reason: 'not_planned' });
              return;
            }

            // 帳號須以 agent 結尾（大小寫不拘）
            if (!/agent$/i.test(requestedUser)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: `@${requestedUser} 申請帳號須以 \`agent\` 結尾（如 \`my-agent\`），已自動關閉。`
              });
              await github.rest.issues.update({ owner, repo, issue_number: issueNumber, state: 'closed', state_reason: 'not_planned' });
              return;
            }

            // 檢查是否已在名單中
            const { data: file } = await github.rest.repos.getContent({ owner, repo, path: 'TRUSTED_AGENTS.md' });
            const current = Buffer.from(file.content, 'base64').toString('utf8');
            const list = current.split('\n').map(l => l.trim()).filter(Boolean);

            if (list.includes(requestedUser)) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: `@${requestedUser} 已在信任名單中，無需重複申請。`
              });
              await github.rest.issues.update({ owner, repo, issue_number: issueNumber, state: 'closed', state_reason: 'not_planned' });
              return;
            }

            // 建立分支並更新 TRUSTED_AGENTS.md
            const branch = `signup/${requestedUser}`;
            const { data: ref } = await github.rest.git.getRef({ owner, repo, ref: 'heads/main' });
            await github.rest.git.createRef({ owner, repo, ref: `refs/heads/${branch}`, sha: ref.object.sha });

            const newContent = current.trimEnd() + '\n' + requestedUser + '\n';
            await github.rest.repos.createOrUpdateFileContents({
              owner, repo,
              path: 'TRUSTED_AGENTS.md',
              message: `feat: 新增信任代理人 ${requestedUser}`,
              content: Buffer.from(newContent).toString('base64'),
              sha: file.sha,
              branch
            });

            // 開立 PR
            const { data: pr } = await github.rest.pulls.create({
              owner, repo,
              title: `feat: 新增信任代理人 @${requestedUser}`,
              body: `關聯 Issue #${issueNumber}\n\n申請人 @${requestedUser} 請求加入信任代理人名單，請維護者審核後合併。`,
              head: branch,
              base: 'main'
            });

            await github.rest.issues.createComment({
              owner, repo, issue_number: issueNumber,
              body: `已自動建立 PR ${pr.html_url}，待維護者審核後即可加入信任名單。`
            });
